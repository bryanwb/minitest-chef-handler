<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Minitest-chef-handler by calavera</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/calavera/minitest-chef-handler">Fork On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/calavera/minitest-chef-handler/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/calavera/minitest-chef-handler/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Minitest-chef-handler</h1>
          <p>Run minitest suites after your Chef recipes to check the status of your system.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/calavera">calavera</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h2>Motivation</h2>

<p>Working at Engine Yard I have to maintain a quite complicated set of Chef recipes that we use to set up our customers' instances. I need to be sure that everytime someone modifies those recipes, mostly myself, the provisioned services continue working as expected.</p>

<p>There are other solutions that evaluate the configured node after the recipes
are loaded without arriving to the converge phase, like <a href="https://github.com/acrmp/chefspec">ChefSpec</a> or <a href="https://github.com/calavera/rspec-chef">rspec-chef</a>, but I needed something to write integration tests easily. I checked <a href="https://github.com/fujin/chef-minitest">chef-minitest</a> but I'm still amazed by the ugly code that I have to write into the recipes to make it work.</p>

<h2>Installation</h2>

<pre><code>$ gem install minitest-chef-handler
</code></pre>

<h2>Usage</h2>

<ol>
<li>Add the report handler to your client.rb or solo.rb file:</li>
</ol><div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'minitest-chef-handler'</span>

<span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Chef</span><span class="o">::</span><span class="no">Handler</span><span class="o">.</span><span class="n">new</span>
</pre>
</div>


<ol>
<li>Write your tests as normal MiniTest cases extending from MiniTest::Chef::TestCase:</li>
</ol><div class="highlight">
<pre><span class="k">class</span> <span class="nc">TestNginx</span> <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Chef</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_config_file_exist</span>
    <span class="n">assert</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s1">'/etc/nginx.conf'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>You still have access to Chef's <code>run_status</code>, <code>node</code> and <code>run_context</code> from your tests:</p>

<div class="highlight">
<pre><span class="k">class</span> <span class="nc">TestNginx</span> <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Chef</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_succeed</span>
    <span class="n">assert</span> <span class="n">run_status</span><span class="o">.</span><span class="n">success?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<h2>Further configuration</h2>

<p>These are the options the handler accepts:</p>

<ul>
<li>:path =&gt; where your test files are, './test/test_*.rb' by default</li>
<li>:filter =&gt; filter test names on pattern</li>
<li>:seed =&gt; set random seed</li>
<li>:verbose =&gt; show progress processing files.</li>
</ul><p>Example:</p>

<div class="highlight">
<pre><span class="n">handler</span> <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Chef</span><span class="o">::</span><span class="no">Handler</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
  <span class="ss">:path</span>    <span class="o">=&gt;</span> <span class="s1">'./cookbooks/test/*_test.rb'</span><span class="p">,</span>
  <span class="ss">:filter</span>  <span class="o">=&gt;</span> <span class="s1">'foo'</span><span class="p">,</span>
  <span class="ss">:seed</span>    <span class="o">=&gt;</span> <span class="nb">srand</span><span class="p">,</span>
  <span class="ss">:verbose</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">})</span>

<span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="n">handler</span>
</pre>
</div>


<h2>Chef server distribution</h2>

<p>The instructions abow have described how to use it in a Chef solo installation. If you want to distribute the handler to your Chef server check either the chef_handler cookbooks in the examples or <a href="https://github.com/btm/minitest-handler-cookbook">minitest-handler-cookbook</a>.</p>

<h2>Copyright</h2>

<p>Copyright (c) 2012 David Calavera. See LICENSE for details.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>